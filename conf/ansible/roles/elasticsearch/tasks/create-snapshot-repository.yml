- name: Add access key to Elasticsearch keystore (non-interactive)
  ansible.builtin.command: |
    echo '{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_B2_ACCESS_KEY }}' | ./elasticsearch-keystore add -f -x --stdin s3.client.default.access_key
  args:
    chdir: /usr/share/elasticsearch/bin

- name: Add secret key to Elasticsearch keystore (non-interactive)
  ansible.builtin.command: |
    echo '{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_B2_SECRET_KEY  }}' | ./elasticsearch-keystore add -f -x --stdin s3.client.default.secret_key
  args:
    chdir: /usr/share/elasticsearch/bin

- name: Reload secure settings
  ansible.builtin.uri:
    url: "{{ es_api_scheme }}://{{ es_api_host }}:{{ es_api_port }}/_nodes/reload_secure_settings?pretty"
    method: POST
    status_code: 200
    timeout: 30
    headers:
      Content-Type: "application/json"
  register: reload_secure_settings
  retries: 6
  delay: 10
  until: reload_secure_settings.status == 200
  when: not ansible_check_mode

- name: Create snapshot repository
  ansible.builtin.uri:
    url: "{{ es_api_scheme }}://{{ es_api_host }}:{{ es_api_port }}/_snapshot/{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_REPO }}"
    method: PUT
    body: "{{ lookup('template', '../roles/elasticsearch/templates/es-snapshot-repository.json.j2') }}"
    body_format: json
    status_code: 200
    timeout: 30
    headers:
      Content-Type: "application/json"
  register: snapshot_repository_creation
  retries: 6
  delay: 10
  until: snapshot_repository_creation.status == 200
  when: not ansible_check_mode

- name: Get snapshot repository
  ansible.builtin.uri:
    url: "{{ es_api_scheme }}://{{ es_api_host }}:{{ es_api_port }}/_snapshot/{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_REPO }}/_verify"
    method: POST
    status_code: 200
    headers:
      Content-Type: "application/json"
  register: repository_validation
  when: not ansible_check_mode

- name: Verify snapshot repository creation
  ansible.builtin.assert:
    that:
      - repository_validation.status == 200
      - repository_validation.json is defined
    success_msg: "Snapshot repository '{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_REPO }}' is properly configured"
    fail_msg: "Snapshot repository validation failed for '{{ sourced_env.ELASTICSEARCH_NEWSSCRIBE_SNAPSHOT_REPO }}'"
  when: not ansible_check_mode
