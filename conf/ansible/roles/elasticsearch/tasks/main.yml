---
- name: Update the server and install required packages
  apt:
    name: apt-transport-https
    update_cache: yes
    state: present
  tags:
    - packages

- name: check-set-parameters
  import_tasks: elasticsearch-parameters.yml
  tags:
      - always

- name: Install Java
  import_tasks: java.yml
  when: es_java_install | default(true)
  tags:
    - java

- name: Add ElasticSearch GPG key
  apt_key:
    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    state: present
    keyring: /usr/share/keyrings/elasticsearch-keyring.gpg
  tags:
    - repository

- name: Add ElasticSearch repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/{{ es_major_version }}/apt stable main"
    state: present
    filename: "elastic-{{ es_major_version }}"
  tags:
    - repository

- name: Install ElasticSearch
  apt:
    name: elasticsearch
    state: present
    update_cache: yes
  tags:
    - install

- name: Generate Elasticsearch configuration
  import_tasks: elasticsearch-config.yml
  notify: restart elasticsearch
  tags:
    - config

- name: Start Elasticsearch service
  service:
    name: elasticsearch
    state: started
    enabled: yes
  tags:
    - service

- name: Wait for Elasticsearch to start
  uri:
    url: "{{ es_api_uri }}"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 60
  delay: 5
  tags:
    - verify
  ignore_errors: true

- name: Install statsd agent
  ansible.builtin.include_tasks:
    file: "../../tasks/install-statsd-agent.yml"
  tags:
    - stats
